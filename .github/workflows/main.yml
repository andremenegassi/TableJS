name: main.deploy

on: [workflow_dispatch]
  push:
    branches: [ "master"]
env:
    #Servidor de CI-CD
    CHAVE_SSH: /home/ubuntu/actions-runner/key-ssh/github-actions
    CAMINHO_PROJETO: ${{ github.workspace }}/src/TDW/TDW.Presentation.Painel
    CAMINHO_PROJETO_PASTA_COMPILACAO: /home/ubuntu/actions-runner/temp-publish-files/super-painel-digital-backoffice
    
    IP_SERVIDOR_IMPLANTACAO: 10.0.0.109

jobs:
  deploy-init:
    runs-on: self-hosted
      
    steps:
      - uses: actions/checkout@v3
          
      - name: INICIANDO A PUBLICAÇÃO
        run: echo INICIANDO...

      - name: npm install, build, and test
       run: |
        npm install
        npm run build --if-present
        npm run test --if-present

  producao-deploy:
    if: github.ref == 'refs/heads/main'
    needs: [deploy-init]
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - uses: actions/checkout@v3
      
      - name: INICIANDO A PUBLICAÇÃO PARA PRODUÇÃO
        run: echo INICIANDO...

      - name: Conectar via SSH no servidor de Produção e gerar um backup do projeto atual
        uses: appleboy/scp-action@v0.1.4
        with:
          host: 129.153.83.94
          username: andremenegassi
          password: 12345678
          port: 22
          source: "*"
          target: "/home/andremenegassi/htdocs/www.andremenegassi.com.br"
